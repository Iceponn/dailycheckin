<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Check-in & Share</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .point-float {
            position: fixed;
            pointer-events: none;
            z-index: 100;
            font-weight: bold;
            font-size: 2rem;
            color: #059669;
            animation: floatUp 1.5s ease-out forwards;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-100px); }
        }
        .fb-container {
            width: 100%;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            justify-content: center;
        }
    </style>
</head>
<body class="pb-10">
    <div class="max-w-md mx-auto">
        <!-- Profile Header -->
        <div class="bg-white p-6 rounded-b-3xl shadow-sm mb-6 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div id="profile-img-container" class="relative">
                    <img id="profile-img" src="https://via.placeholder.com/60" alt="Profile" class="w-16 h-16 rounded-full border-2 border-green-500 shadow-sm">
                    <div class="absolute bottom-0 right-0 w-4 h-4 bg-green-500 border-2 border-white rounded-full"></div>
                </div>
                <div>
                    <h2 id="display-name" class="text-xl font-bold text-gray-800">Loading...</h2>
                    <p class="text-sm text-gray-500">Welcome back!</p>
                </div>
            </div>
            <div class="text-right">
                <div id="points-display" class="text-3xl font-black text-green-600 animate__animated">0</div>
                <div class="text-[10px] uppercase tracking-wider font-bold text-gray-400">Total Points</div>
            </div>
        </div>

        <!-- Check-in Status Card -->
        <div id="checkin-banner" class="mx-4 mb-6 p-4 bg-green-50 border border-green-100 rounded-2xl flex items-center justify-between hidden">
            <div class="flex items-center space-x-3">
                <span class="text-2xl">âœ…</span>
                <div>
                    <h3 class="font-bold text-green-800 text-sm">Checked In!</h3>
                    <p class="text-xs text-green-600">+1 point awarded for opening</p>
                </div>
            </div>
        </div>

        <!-- Facebook Content -->
        <div class="px-4">
            <div class="bg-white rounded-2xl shadow-sm overflow-hidden mb-6">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="font-bold text-gray-700">Share & Earn Points</h3>
                    <span class="bg-blue-100 text-blue-600 text-xs font-bold px-2 py-1 rounded-full">+5 Points</span>
                </div>
                
                <div class="fb-container p-2">
                    <iframe id="fb-iframe" src="https://www.facebook.com/plugins/post.php?href=https%3A%2F%2Fwww.facebook.com%2FThailand.AIA%2Fposts%2Fpfbid0q4yrXMdCRBUvKguN12gF5wp7NDE1pSbKWbferGZa4t6giv1of51qK7GbUryfV9Zfl&show_text=true&width=500" width="100%" height="500" style="border:none;overflow:hidden" scrolling="no" frameborder="0" allowfullscreen="true" allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"></iframe>
                </div>

                <div class="p-4">
                    <button id="share-btn" class="w-full bg-[#1877F2] hover:bg-blue-700 text-white font-bold py-4 rounded-xl flex items-center justify-center space-x-2 transition-all active:scale-95 shadow-lg shadow-blue-200">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg>
                        <span>Share to Facebook</span>
                    </button>
                    <p class="text-center text-[11px] text-gray-400 mt-3">Points will be added after you return from sharing</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full text-sm font-medium opacity-0 pointer-events-none transition-opacity duration-300 z-50">
        Points Updated!
    </div>

    <script>
        // Constants
        const LIFF_ID = '2007784462-JesMJITr';
        const FB_POST_URL = 'https://www.facebook.com/Thailand.AIA/posts/pfbid0q4yrXMdCRBUvKguN12gF5wp7NDE1pSbKWbferGZa4t6giv1of51qK7GbUryfV9Zfl';
        
        // State Management
        let points = parseInt(localStorage.getItem('user_points') || '0');

        // Initialization
        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }

                const profile = await liff.getProfile();
                document.getElementById('display-name').textContent = profile.displayName;
                document.getElementById('profile-img').src = profile.pictureUrl || 'https://via.placeholder.com/60';
                
                // Update UI with existing points first
                updatePointsUI(false);

                // Award point for EVERY page open
                processCheckIn();

            } catch (err) {
                console.error('Initialization failed', err);
                document.getElementById('display-name').textContent = "Guest User";
                updatePointsUI(false);
            }
        }

        function processCheckIn() {
            // No date check anymore - simple increment on load
            setTimeout(() => {
                addPoints(1, "Check-in Reward");
                const banner = document.getElementById('checkin-banner');
                banner.classList.remove('hidden');
                banner.classList.add('animate__animated', 'animate__fadeInDown');
            }, 800);
        }

        function addPoints(amount, reason) {
            points += amount;
            localStorage.setItem('user_points', points.toString());
            
            showPointAnimation(amount);
            updatePointsUI(true);
            showToast(`+${amount} Points: ${reason}`);
        }

        function updatePointsUI(shouldAnimate) {
            const el = document.getElementById('points-display');
            el.textContent = points;
            
            if (shouldAnimate) {
                el.classList.remove('animate__bounceIn');
                void el.offsetWidth; // Trigger reflow
                el.classList.add('animate__bounceIn');
            }
        }

        function showPointAnimation(amount) {
            const float = document.createElement('div');
            float.className = 'point-float';
            float.textContent = `+${amount}`;
            
            const rect = document.getElementById('points-display').getBoundingClientRect();
            float.style.left = `${rect.left + 10}px`;
            float.style.top = `${rect.top}px`;
            
            document.body.appendChild(float);
            setTimeout(() => float.remove(), 1500);
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 3000);
        }

        // Improved Share Logic for LINE Browser
        document.getElementById('share-btn').addEventListener('click', () => {
            const shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(FB_POST_URL)}`;
            
            // liff.openWindow is the correct way to open external links within LINE
            liff.openWindow({
                url: shareUrl,
                external: true
            });

            // We award points assuming the user completes the share 
            // Since we can't track the actual share success via URL sharer
            setTimeout(() => {
                addPoints(5, "Share Reward");
            }, 1000);
        });

        window.onload = init;
    </script>
</body>
</html>
